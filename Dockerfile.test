FROM clojure:temurin-21-lein

WORKDIR /app

RUN apt-get update \
  && apt-get install -y --no-install-recommends \
     ca-certificates \
     curl \
     python3 \
     libglib2.0-0 \
     libpango-1.0-0 \
     libpangoft2-1.0-0 \
     libpangocairo-1.0-0 \
     libcairo2 \
     libgdk-pixbuf-2.0-0 \
     libffi8 \
     fontconfig \
     fonts-dejavu \
     fonts-noto-cjk \
  && rm -rf /var/lib/apt/lists/*

RUN curl -LsSf https://astral.sh/uv/install.sh | sh
ENV PATH="/root/.local/bin:$PATH"
RUN uv run --with weasyprint python -c "import weasyprint"
RUN mkdir -p /usr/local/share/fonts/source-serif-pro \
  && curl -L -o /usr/local/share/fonts/source-serif-pro/SourceSerifPro-Regular.ttf https://raw.githubusercontent.com/google/fonts/main/ofl/sourceserifpro/SourceSerifPro-Regular.ttf \
  && curl -L -o /usr/local/share/fonts/source-serif-pro/SourceSerifPro-Italic.ttf https://raw.githubusercontent.com/google/fonts/main/ofl/sourceserifpro/SourceSerifPro-Italic.ttf \
  && curl -L -o /usr/local/share/fonts/source-serif-pro/SourceSerifPro-SemiBold.ttf https://raw.githubusercontent.com/google/fonts/main/ofl/sourceserifpro/SourceSerifPro-SemiBold.ttf \
  && curl -L -o /usr/local/share/fonts/source-serif-pro/SourceSerifPro-Bold.ttf https://raw.githubusercontent.com/google/fonts/main/ofl/sourceserifpro/SourceSerifPro-Bold.ttf \
  && fc-cache -f

COPY project.clj ./project.clj
COPY tests.edn ./tests.edn
RUN lein with-profile +test deps

COPY resources ./resources
COPY src ./src
COPY test ./test
COPY baseline-research ./baseline-research
COPY Dockerfile ./Dockerfile

ENTRYPOINT ["lein", "test"]

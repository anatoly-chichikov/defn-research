#!/usr/bin/env bash
set -euo pipefail

repo="$(git rev-parse --show-toplevel)"
cache="${HOME}/.m2"
delta="$(git diff --name-only --cached)"
build=0
docker run --rm -v "${repo}":/app -v "${cache}":/root/.m2 -w /app clojure:temurin-21-lein lein lint
docker run --rm -v "${repo}":/app -v "${cache}":/root/.m2 -w /app clojure:temurin-21-lein lein fmt:check
if [ -z "${delta}" ]; then
  delta="$(git diff --name-only)"
fi
if ! docker image inspect research-test >/dev/null 2>&1; then
  build=1
elif echo "${delta}" | grep -E -q '^(project\.clj|tests\.edn|Dockerfile\.test|src/|test/|resources/)'; then
  build=1
fi
if [ "${build}" -eq 1 ]; then
  docker build -t research-test -f "${repo}/Dockerfile.test" "${repo}"
else
  echo "Skipping docker build because no relevant changes"
fi
docker run --rm research-test
